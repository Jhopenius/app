# Бухгалтерия ВГУИТ (VSUET Accounting)

Проект: информационная система учета для Воронежского Государственного Университета Инженерных Технологий (ВГУИТ / VSUET).

Цель — показать полный цикл: проектирование БД, реализация бизнес‑логики, интерфейс для работы с данными, отчеты и сервисные функции (резервное копирование, восстановление, архивирование). Реализация на Python + Streamlit + PostgreSQL (в Docker). Используется чистая архитектура, SQLAlchemy для работы с БД, Pydantic для схем и pydantic‑settings для конфигов.

---

## 1. Предметная область и назначение

**ИС «Бухгалтерия ВГУИТ»** автоматизирует учет операций по подразделениям университета:

- учет сотрудников и их зарплатных выплат;
- учет поставщиков и расходов по подразделениям;
- формирование отчетов (детализация и сводные показатели);
- сервисные функции: бэкап, восстановление, архивирование старых выплат.

**Кому нужна ИС:** бухгалтерия и финансовые отделы университета. Она дает целостное представление о расходах и выплатах, позволяет быстро получать отчеты и формировать архив.

**Динамика процессов:**

- появляются новые подразделения/сотрудники/поставщики;
- вносятся расходы и выплаты (с датами и суммами);
- часть выплат архивируется по заданной дате;
- отчеты строятся по заданным фильтрам.

---

## 2. Сущности, связи и нормализация

**Сущности (6 таблиц):**

- `departments` — подразделения
- `employees` — сотрудники
- `vendors` — поставщики
- `expenses` — расходы
- `payrolls` — выплаты сотрудникам
- `archive_log` — архив (JSON‑слепки записей)

**Связи:**

- `employees.department_id → departments.id` (1:M)
- `expenses.department_id → departments.id` (1:M)
- `expenses.vendor_id → vendors.id` (1:M)
- `payrolls.employee_id → employees.id` (1:M)

**Нормализация:**

- Данные разнесены по сущностям, нет дублирования объектов справочников.
- Денежные суммы вынесены в отдельные таблицы операций (`expenses`, `payrolls`).
- Архив хранится отдельно, без дублирования структуры основных таблиц.

---

## 3. Атрибуты (требования соблюдены)

Присутствуют поля:

- **суммирование**: `amount`, `net_amount`, `base_salary`;
- **дата/время**: `hire_date`, `expense_date`, `period_start`, `period_end`, `paid_at`, `archived_at`;
- **логическое**: `is_active`, `is_approved`, `is_paid`;
- **текстовое**: `name`, `code`, `full_name`, `inn`, `source_table`.

Всего таблиц: 6. Общее количество полей соответствует требованиям (в сумме 20+).

---

## 4. Отчеты

Реализованы отчеты и выгрузка в CSV:

- **Детализация расходов** по подразделению/поставщику/периоду, фильтр «только утвержденные».
- **Сводка расходов** по подразделениям.
- **Детализация выплат** по сотруднику/периоду, фильтр «оплачено/не оплачено», опционально с архивом.
- **Сводка выплат** по подразделениям.

---

## 5. Архитектура и реализация (чистая архитектура)

Структура проекта:

``` structure
src/vsuet_accounting/
  domain/           # Pydantic схемы
  application/      # бизнес‑логика, отчеты
  infrastructure/   # SQLAlchemy модели, инициализация БД, бэкап
  presentation/     # Streamlit интерфейс
```

### Domain

- `domain/schemas.py` — Pydantic‑модели (валидация входных данных).

### Application

- `application/services.py` — бизнес‑логика: CRUD, отчеты, запуск архивации.

### Infrastructure

- `infrastructure/db/models.py` — SQLAlchemy модели.
- `infrastructure/db/init_db.py` — создание схемы, SQL‑процедуры/представления, сидирование.
- `infrastructure/db/bootstrap.py` — стартовый скрипт (ожидание БД, создание таблиц, проверка пустоты, заполнение).
- `infrastructure/backup.py` — бэкап/восстановление через `pg_dump`/`psql`.

### Presentation

- `presentation/ui.py` — интерфейс Streamlit (формы CRUD, отчеты, сервис).

---

## 6. Работа с базой данных

**Таблицы и представления:**

- основная схема: `db/schema.sql` (описание таблиц + функции + представления);
- тестовые данные: `db/seed.sql`.

**Архивация:**

- функция `archive_payrolls(cutoff_date)` переносит выплаты в `archive_log` и удаляет из `payrolls`.
- представление `payrolls_archive_view` показывает архивированные записи.
- представление `payrolls_all` объединяет активные и архивные выплаты.

**Автозаполнение:**

- при старте контейнера вызывается `entrypoint.sh` → `bootstrap.py`;
- создаются таблицы, проверяется пустота БД и загружаются данные.

---

## 7. Интерфейс Streamlit

Разделы приложения:

- **Overview** — метрики по количеству записей.
- **Reference Data** — справочники:
  - Departments (подразделения)
  - Employees (сотрудники)
  - Vendors (поставщики)
- **Operations** — операции:
  - Expenses (расходы)
  - Payrolls (выплаты)
- **Reports** — отчеты и выгрузка в CSV.
- **Service** — сервисные функции:
  - резервное копирование;
  - восстановление из файла;
  - архивирование выплат до выбранной даты.

---

## 8. Конфигурация

Конфигурация хранится в `.env` (пример — `.env.example`).
Используются `pydantic-settings` и загрузка переменных окружения.

Основные параметры:

- `POSTGRES_HOST`, `POSTGRES_PORT`, `POSTGRES_DB`, `POSTGRES_USER`, `POSTGRES_PASSWORD`
- `BACKUP_DIR` — каталог бэкапов

---

## 9. Запуск проекта

### Docker Compose (рекомендуется)

1. Подготовить `.env`:

   ```bash
   cp .env.example .env
   ```

2. Запуск:

   ```bash
   docker compose up --build
   ```

3. Открыть интерфейс:
   - <http://localhost:8501>

Бэкапы сохраняются в `./backups` (примонтировано как `/app/backups`).

### Локально (uv)

1. Установить uv:

   ```bash
   pip install uv
   ```

2. Установить зависимости:

   ```bash
   uv pip install --system .
   ```

3. Запустить приложение:

   ```bash
   streamlit run src/vsuet_accounting/app.py
   ```

Для локального запуска измените в `.env`:

``` .env
POSTGRES_HOST=localhost
```

---

## 10. Где что находится (подсказка для изучения)

- Архитектура и бизнес‑логика: `src/vsuet_accounting/application/services.py`
- Описание БД (ORM): `src/vsuet_accounting/infrastructure/db/models.py`
- SQL‑скрипт схемы: `db/schema.sql`
- Сидирование: `src/vsuet_accounting/infrastructure/db/init_db.py`
- Стартовый скрипт контейнера: `entrypoint.sh`
- Интерфейс: `src/vsuet_accounting/presentation/ui.py`
- Конфиги: `.env`, `.env.example`
- Docker: `docker-compose.yml`, `Dockerfile`

---

## Итог

Система соответствует ТЗ: есть минимум 3 сущности, реализованы таблицы с необходимыми типами данных, CRUD‑формы, конструктор отчетов с выгрузкой в файл, сервисные функции бэкапа/восстановления/архивации, а также Docker‑развертывание.
